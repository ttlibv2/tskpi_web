"use strict";(self.webpackChunkTS24AppWeb=self.webpackChunkTS24AppWeb||[]).push([[926],{6926:(ct,b,o)=>{o.r(b),o.d(b,{SendReportModule:()=>lt});var h=o(9808),A=o(8406),U=o(520),p=o(3075),u=o(9690),x=o(750),D=o(857),F=o(1963),L=o(7251),N=o(1708),f=o(8590),O=o(1609),g=o(9646),C=o(7445),T=o(4351),z=o(1005),y=o(8505),S=o(3900),J=o(5698),Y=o(262),M=o(6431),w=o(2843),t=o(5e3);let Q=(()=>{class r{constructor(n){this.ccfig=n}send(n,e){let a=JSON.stringify(e.body||{}),l=Object.assign({},e.params,{action:e.action}),s=this.ccfig.read().report_url;return(0,u.EU)(s)?(0,w._)(" L\u1ed7i kh\xf4ng l\u1ea5y \u0111\u01b0\u1ee3c c\u1ea5u h\xecnh [report_url]"):this.ccfig.http().send(n,s,{params:l,body:a}).pipe((0,S.w)(d=>(0,g.of)(d.result)))}sendRow(n,e){return this.send("POST",{action:"appendRow",params:{email:n},body:{item:e}})}}return r.\u0275fac=function(n){return new(n||r)(t.LFG(M.t))},r.\u0275prov=t.Yz7({token:r,factory:r.\u0275fac,providedIn:"root"}),r})();var m=o(4546),I=o(1894),R=o(3154),Z=o(6042),j=o(2643),P=o(2683),v=o(3677),E=o(4219),G=o(5969);function X(r,c){1&r&&t._UZ(0,"i",24)}function k(r,c){1&r&&t._UZ(0,"i",25)}function B(r,c){1&r&&t._UZ(0,"i",24)}function $(r,c){1&r&&t._UZ(0,"i",25)}function V(r,c){1&r&&t._UZ(0,"i",26)}function K(r,c){1&r&&t._UZ(0,"i",24)}function H(r,c){1&r&&t._UZ(0,"i",18)}function W(r,c){1&r&&t._UZ(0,"i",24)}function q(r,c){1&r&&t._UZ(0,"i",18)}function _(r,c){1&r&&t._UZ(0,"i",24)}let tt=(()=>{class r{constructor(n,e,a,l,s,d,i){this.router=n,this.fb=e,this.csrv=a,this.cgrid=l,this.cuser=s,this.cgsend=d,this.cticket=i,this.KEY_GRID_TYPE="send_report",this.agOption=this.createAgOption(),this.agColumns=[],this.agColumnFix={},this.allData=[],this.agColumnApi=void 0,this.agApi=void 0,this.isRunImport=!1,this.isSendReport=!1,this.isLoadSearch=!1,this.isInitPage=!1,this.dataCache=[],this.totalRow=0,this.execRunImport=void 0,this.execRunSend=void 0,this.msgObj=this.msgSendDefault()}ngOnInit(){this.isInitPage=!0,this.searchForm=this.fb.group({fromToDate:[[new Date,new Date]]}),this.userDetail=this.cuser.read(),this.cgrid.getColumnAgFromCache(x.z).subscribe({next:n=>{this.agColumnFix=n.column_fix,this.agColumns=n.column_fix.def,this.isInitPage=!1},error:n=>{this.isInitPage=!1,console.log(n)}}),this.onSearchTicket()}get totalSelect(){return(0,u.Ft)(this.agApi)?0:this.agApi.getSelectedRows().length}get disabledAction(){return this.isLoadSearch||this.isRunImport||this.isSendReport||this.isInitPage}get config(){return this.csrv.config().read()}msgSendDefault(){return{title:"K\u1ebft qu\u1ea3",total:0,ok:0,err:0,action:""}}createAgOption(){return{domLayout:"autoHeight"}}sortGridByIndex(n){(0,u.Ft)(this.agApi)||this.agApi.setPostSort(e=>[{colId:"index_stt",sort:n}])}onAgInit(n){this.agColumnApi=n.columnApi,this.agApi=n.api,this.cgrid.getColumnAgFromCache(x.IN).subscribe({next:e=>{f.q.fixColDef(this.userDetail,this.agApi),f.q.showOnlyColumns(this.agColumnApi,null,e.grid_field.send_report)},error:e=>{this.isInitPage=!1,console.log(e)}})}onSearchTicket(){if(this.searchForm.invalid)return;this.dataCache=[],this.totalRow=0,this.isLoadSearch=!0;const n=this.searchForm.value,e=new h.uU("en-US").transform(n.fromToDate[0],"yyyy-MM-dd")+"T00:00:00",a=new h.uU("en-US").transform(n.fromToDate[1],"yyyy-MM-dd")+"T23:59:59";let l=`L\u1ea5y d\u1eef li\u1ec7u <br/>- T\u1eeb ng\xe0y: <b>${e}</b> <br/> - \u0110\u1ebfn ng\xe0y: <b>${a}</b>`,s=this.csrv.shared().loading(`\u0110ang ${l}`);this.cticket.findAll({create_max:a,create_min:e,is_send_ticket:!0,is_send_report:!1}).subscribe({next:i=>{this.dataCache=i=null===i?[]:i,this.convertTicket(i),this.isLoadSearch=!1,this.csrv.alert().remove(s.messageId),this.csrv.alert().success(`[${i.length}] L\u1ea5y Ticket xong r\u1ed3i.`),this.sortGridByIndex("asc")},error:i=>{this.isLoadSearch=!1,this.csrv.alert().remove(s.messageId),u.K$.log("X\u1ea3y ra l\u1ed7i l\u1ea5y d\u1eef li\u1ec7u:",i)}})}convertTicket(n=this.dataCache){this.allData=[];let e=1;for(let a in n){let l=n[a];for(let s in l.chanels){let d=Object.assign({},l,{index_stt:e++,first_chanel:l.chanels[s]});this.totalRow++,this.allData.push(d)}}}goHome(){this.router.navigateByUrl("/")}importXsl(){this.csrv.modal().create({nzTitle:"N\u1ea1p d\u1eef li\u1ec7u t\u1eeb file excel",nzContent:O.Q,nzClassName:"select-file",nzClosable:!1,nzMaskClosable:!1,nzFooter:null,nzComponentParams:{fileMau:this.config.report_filemau}}).afterClose.subscribe(e=>{if("import"===e.act){this.isRunImport=!0;let a=this.agApi.getDisplayedRowCount(),l=e.data.items.map((i,dt)=>Object.assign(Object.assign({},i),{index_stt:a+dt+1,ticket_text:i.ticket_number,chanels:[{value:i.channel_status}],software:{value:i.soft_name},content_help:i.content_support})),s=(0,g.of)(...l).pipe((0,T.b)(i=>(0,g.of)(i).pipe((0,z.g)(2e3))));this.execRunImport=s.subscribe({next:i=>this.agApi.updateRowData({add:[i]}),error:i=>console.warn(i)});let d=(0,C.F)(1e3).subscribe(i=>{!(0,u.Ft)(this.execRunImport)&&this.execRunImport.closed&&(this.isRunImport=!1,d.unsubscribe())})}})}onStopImport(){(0,u.Ft)(this.execRunImport)||this.execRunImport.unsubscribe()}exportXsl(){f.q.exportExcel(this.agApi,this.agColumnApi,{fileName:"send_report"})}onSendReport(){let n=this.agApi.getSelectedNodes();if(0===n.length)return void this.csrv.alert().warning("Vui l\xf2ng ch\u1ecdn d\u1eef li\u1ec7u \u0111\u1ec3 g\u1eedi");let e=this.cuser.read().od_user.email;if((0,u.EU)(e))return void this.csrv.modal().error({nzTitle:"C\u1ea3nh b\xe1o",nzContent:"L\u1ed7i x\xe1c nh\u1eadn email",nzClosable:!1,nzCancelText:"Oki",nzOkText:null});console.log(this.agApi.getDataAsExcel()),this.isSendReport=!0,this.msgObj=this.msgSendDefault();let a=n.map(s=>(0,g.of)(s.rowIndex).pipe((0,y.b)(d=>this.refreshRow(s,{send_status:!0})),(0,S.w)(d=>this.handlerSendNode(s,e))));this.execRunSend=(0,g.of)(...a).pipe((0,T.b)(s=>s.pipe((0,z.g)(2e3)))).subscribe(s=>{this.refreshRow(s.node,Object.assign(Object.assign({},s.data),{send_status:s.status,is_greport:!0})),"error"===s.status?(this.msgObj.err++,this.showErrorAndStop(s.node.data.ticket_id,s.data.error)):this.msgObj.ok++},s=>{this.msgObj.err++,this.refreshRow(s.node,{send_status:"error"}),this.showErrorAndStop(s.node.data.ticket_id,s.error)});let l=(0,C.F)(500).subscribe(s=>{!(0,u.Ft)(this.execRunSend)&&this.execRunSend.closed&&(this.isSendReport=!1,l.unsubscribe())},(0,J.q)(1))}handlerSendNode(n,e){let a=this.getAgValueText(n),l=n.data.ticket_id;return(0,u.J2)(l,0),this.cgsend.sendRow(e,a).pipe((0,y.b)(d=>this.cticket.updateOne(l,{is_greport:!0}).subscribe()),(0,S.w)(d=>(0,g.of)({status:"success",node:n,data:d})),(0,Y.K)(d=>(0,g.of)({status:"error",node:n,data:{error:d}})))}getAgValueText(n){let e=this.agApi.valueService;return this.agColumnApi.getAllDisplayedColumns().map(l=>{let s=e.getValue(l,n);return{[l.getColId()]:s}}).reduce((l,s)=>Object.assign(Object.assign({},l),s),{})}onStopSendReport(){(0,u.Ft)(this.execRunSend)||(this.execRunSend.unsubscribe(),this.csrv.alert().error("\u0110\xe3 d\u1eebng g\u1eedi !!"))}showErrorAndStop(n,e){this.csrv.alert().error(`[${n}] > ${e.message}`),this.onStopSendReport()}refreshRow(n,e={}){f.q.refreshRow(this.agApi,n,e)}}return r.\u0275fac=function(n){return new(n||r)(t.Y36(A.F0),t.Y36(p.qu),t.Y36(F.X),t.Y36(N.P),t.Y36(D.a),t.Y36(Q),t.Y36(L.k))},r.\u0275cmp=t.Xpm({type:r,selectors:[["cy-send-report"]],decls:54,vars:20,consts:[[1,"card"],[1,"card-header"],[1,"card-body"],[1,"row","tool-2","mb-5px","mt-15"],[1,"col-12"],["nz-form","",1,"search-form",3,"nzLayout","formGroup"],[2,"margin-left","2px","width","300px"],[3,"nzFormat"],["type","button","nz-button",""],["class","fa-regular fa-arrows-spin fa-spin",4,"ngIf"],["class","fa-regular fa-magnifying-glass",4,"ngIf"],["nz-button","","type","button","nz-dropdown","","nzTrigger","click",3,"nzDropdownMenu","disabled"],["class","fa-regular fa-people-arrows",4,"ngIf"],["nzMenuNXDL",""],["nz-menu",""],["nz-menu-item","",3,"click"],["nz-menu-item",""],["target","_blank"],[1,"fa-regular","fa-file-excel"],["nz-button","",3,"disabled","click"],["class","fa-regular fa-file-excel",4,"ngIf"],["nz-button","",3,"disabled"],[1,"card","report-grid"],[3,"gridRows","columns"],[1,"fa-regular","fa-arrows-spin","fa-spin"],[1,"fa-regular","fa-magnifying-glass"],[1,"fa-regular","fa-people-arrows"]],template:function(n,e){if(1&n&&(t.TgZ(0,"div",0)(1,"div",1)(2,"h1"),t._uU(3,"T\u1ea1o B\xe1o C\xe1o G\u1eedi Google Drive"),t.qZA()(),t.TgZ(4,"div",2)(5,"div",3)(6,"div",4)(7,"form",5)(8,"nz-form-item")(9,"nz-form-control",6),t._UZ(10,"nz-range-picker",7),t.qZA()(),t.TgZ(11,"nz-form-item")(12,"nz-form-control")(13,"button",8),t.YNc(14,X,1,0,"i",9),t.YNc(15,k,1,0,"i",10),t.TgZ(16,"span"),t._uU(17,"L\u1ea5y Ticket"),t.qZA()(),t.TgZ(18,"button",8),t.YNc(19,B,1,0,"i",9),t.YNc(20,$,1,0,"i",10),t.TgZ(21,"span"),t._uU(22,"L\u1ea5y DL BC"),t.qZA()(),t.TgZ(23,"button",11),t.YNc(24,V,1,0,"i",12),t.YNc(25,K,1,0,"i",9),t.TgZ(26,"span"),t._uU(27,"N\u1ea1p / Xu\u1ea5t DL"),t.qZA()(),t.TgZ(28,"nz-dropdown-menu",null,13)(30,"ul",14)(31,"li",15),t.NdJ("click",function(){return e.importXsl()}),t.TgZ(32,"a"),t._uU(33,"N\u1ea1p d\u1eef li\u1ec7u"),t.qZA()(),t.TgZ(34,"li",15),t.NdJ("click",function(){return e.exportXsl()}),t.TgZ(35,"a"),t._uU(36,"Xu\u1ea5t d\u1eef li\u1ec7u"),t.qZA()(),t.TgZ(37,"li",16)(38,"a",17),t._UZ(39,"i",18),t._uU(40,"File m\u1eabu "),t.qZA()()()(),t.TgZ(41,"button",19),t.NdJ("click",function(){return e.onSendReport()}),t.YNc(42,H,1,0,"i",20),t.YNc(43,W,1,0,"i",9),t.TgZ(44,"span"),t._uU(45,"G\u1eedi BC"),t.qZA()(),t.TgZ(46,"button",21),t.YNc(47,q,1,0,"i",20),t.YNc(48,_,1,0,"i",9),t.TgZ(49,"span"),t._uU(50,"T\u1ea1o ticket"),t.qZA()()()()()()()()(),t.TgZ(51,"div",22)(52,"div",2),t._UZ(53,"cy-custom-grid",23),t.qZA()()),2&n){const a=t.MAs(29);t.xp6(7),t.Q6J("nzLayout","inline")("formGroup",e.searchForm),t.xp6(3),t.Q6J("nzFormat","yyyy-MM-dd"),t.xp6(4),t.Q6J("ngIf",e.isLoadSearch),t.xp6(1),t.Q6J("ngIf",!e.isLoadSearch),t.xp6(4),t.Q6J("ngIf",e.isLoadSearch),t.xp6(1),t.Q6J("ngIf",!e.isLoadSearch),t.xp6(3),t.Q6J("nzDropdownMenu",a)("disabled",e.disabledAction),t.xp6(1),t.Q6J("ngIf",!e.isRunImport),t.xp6(1),t.Q6J("ngIf",e.isRunImport),t.xp6(13),t.uIk("href",null==e.config?null:e.config.report_filemau,t.LSH),t.xp6(3),t.Q6J("disabled",e.disabledAction),t.xp6(1),t.Q6J("ngIf",!e.isSendReport),t.xp6(1),t.Q6J("ngIf",e.isSendReport),t.xp6(3),t.Q6J("disabled",e.disabledAction),t.xp6(1),t.Q6J("ngIf",!e.isSendReport),t.xp6(1),t.Q6J("ngIf",e.isSendReport),t.xp6(5),t.Q6J("gridRows",e.allData)("columns",e.agColumns)}},directives:[p._Y,p.JL,m.Lr,p.sg,I.SK,m.Nx,I.t3,m.Fd,R.uw,R.wS,Z.ix,j.dQ,P.w,h.O5,v.wA,v.cm,v.RR,E.wO,E.r9,G.P],styles:[".send-report .range-date{width:240px}.send-report .tool-send .send-log{width:unset}.send-report .tool-send .send-log label{margin-right:5px}.send-report .tool-send .send-log label i{margin-left:5px}.send-report .tool-send .send-log label .err{color:var(--red)}.send-report .tool-send .send-log label .oki{color:var(--success)}.send-report .tool-send .send-log label .total{color:var(--indigo)}.send-report .tool-send .send-log label .run{color:var(--info)}.send-report .tool-send .send-log label .act{color:var(--primary)}.send-report .ag-grid2 .fal{font-size:1rem;font-weight:inherit}.send-report .ag-grid2 .fal.fa-exclamation-circle{color:var(--red)}.send-report .ag-grid2 .fal.fa-times{color:var(--danger)}.send-report .ag-grid2 .fal.fa-comment,.send-report .ag-grid2 .fal .fa-check{color:var(--info)}\n"],encapsulation:2}),r})();var et=o(7581),nt=o(1047),ot=o(3087),rt=o(5737),st=o(9727),it=o(1298);const at=[{path:"",component:tt}];let lt=(()=>{class r{}return r.\u0275fac=function(n){return new(n||r)},r.\u0275mod=t.oAB({type:r}),r.\u0275inj=t.cJS({imports:[[h.ez,U.JF,p.u5,p.UX,A.Bz.forChild(at),Z.sL,ot.PV,v.b1,R.Hb,st.gR,et.cS,nt.o7,rt.S,it.w,m.U5]]}),r})()}}]);