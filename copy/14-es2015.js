(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{LB2t:function(e,t,n){"use strict";n.r(t),n.d(t,"SendReportModule",(function(){return ee}));var i=n("2kYt"),s=n("sEIs"),o=n("vobO"),r=n("nIj0"),a=n("K8Gv"),c=n("J50X"),l=n("Tu4v"),b=n("2mfu"),d=n("BlE5"),u=n("evcz"),p=n("77ZH"),h=n("UbAx"),g=n("ROBh"),m=n("3p4X"),f=n("5uDM"),T=n("BwBJ"),S=n("8j5Y"),z=n("TLy2"),O=n("J+dc"),y=n("4e/d"),j=n("qBiZ"),I=n("47ST"),v=n("EM62");let x=(()=>{class e{constructor(e){this.ccfig=e}send(e,t){let n=JSON.stringify(t.body||{}),i=Object.assign({},t.params,{action:t.action}),s=this.ccfig.read().report_url;return Object(a.l)(s)?Object(I.a)(" L\u1ed7i kh\xf4ng l\u1ea5y \u0111\u01b0\u1ee3c c\u1ea5u h\xecnh [report_url]"):this.ccfig.http().send(e,s,{params:i,body:n}).pipe(Object(z.a)(e=>Object(g.a)(e.result)))}sendRow(e,t){return this.send("POST",{action:"appendRow",params:{email:e},body:{item:t}})}}return e.\u0275fac=function(t){return new(t||e)(v.Xb(j.a))},e.\u0275prov=v.Jb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();class D{constructor(){this.xmlDoc=document}createElement(e){return new R(e)}}class R{constructor(e){this.tagName=e,this.attrMap={},this.childs=[]}setAttribute(e,t){this.attrMap[e]=t}appendChild(e){this.childs.push(e)}getXmlText(){let e=this.isChildEmpty()?" />":`>\n\t${this.buildChild()}\n</${this.tagName}>`;return`<${this.tagName} ${this.buildAttr()}${e}`}isChildEmpty(){return 0===this.childs.length}buildAttr(){return Object.entries(this.attrMap).map(e=>`${e[0]}=${e[1]}`).join(" ")}buildChild(){return this.childs.map(e=>e.getXmlText()).join("\t\n")}}var w=n("1EA0"),k=n("duTG"),A=n("ZTwM"),C=n("1spV"),_=n("B0q8"),B=n("XS/p"),M=n("JbzU"),E=n("lSkQ"),N=n("fWDI"),L=n("mybp");function F(e,t){1&e&&v.Ob(0,"i",33),2&e&&v.jc("nzType","sync")("nzSpin",!0)}function X(e,t){1&e&&v.Ob(0,"i",34)}function $(e,t){1&e&&v.Ob(0,"i",35)}function P(e,t){1&e&&v.Ob(0,"i",33),2&e&&v.jc("nzType","sync")("nzSpin",!0)}function G(e,t){if(1&e){const e=v.Ub();v.Tb(0,"button",36),v.ac("click",(function(){return v.sc(e),v.dc().onStopImport()})),v.Ob(1,"i",37),v.Tb(2,"span"),v.Dc(3,"D\u1eebng n\u1ea1p DL"),v.Sb(),v.Sb()}2&e&&(v.zb(1),v.jc("nzType","sync"))}function J(e,t){1&e&&v.Ob(0,"i",38)}function U(e,t){1&e&&v.Ob(0,"i",33),2&e&&v.jc("nzType","sync")("nzSpin",!0)}function V(e,t){1&e&&(v.Tb(0,"label"),v.Tb(1,"span",44),v.Dc(2,"Running =>"),v.Sb(),v.Sb())}function q(e,t){if(1&e&&(v.Rb(0),v.Ob(1,"nz-divider",39),v.Tb(2,"nz-input-group",40),v.Bc(3,V,3,0,"label",30),v.Tb(4,"label"),v.Dc(5,"Oki"),v.Tb(6,"span",41),v.Dc(7),v.Sb(),v.Tb(8,"i"),v.Dc(9,"+"),v.Sb(),v.Sb(),v.Tb(10,"label"),v.Dc(11,"Err"),v.Tb(12,"span",42),v.Dc(13),v.Sb(),v.Tb(14,"i"),v.Dc(15,"="),v.Sb(),v.Sb(),v.Tb(16,"label"),v.Dc(17,"TS"),v.Tb(18,"span",43),v.Dc(19),v.Sb(),v.Sb(),v.Sb(),v.Qb()),2&e){const e=v.dc();v.zb(3),v.jc("ngIf",e.isSendReport),v.zb(4),v.Fc("[",(null==e.msgObj?null:e.msgObj.ok)||0,"]"),v.zb(6),v.Fc("[",(null==e.msgObj?null:e.msgObj.err)||0,"]"),v.zb(6),v.Fc("[",(null==e.msgObj?null:e.msgObj.total)||e.totalSelect,"]")}}function H(e,t){if(1&e){const e=v.Ub();v.Tb(0,"div"),v.Ob(1,"nz-divider",39),v.Tb(2,"a",45),v.ac("click",(function(){return v.sc(e),v.dc().onStopSendReport()})),v.Tb(3,"span"),v.Dc(4,"D\u1eebng l\u1ea1i"),v.Sb(),v.Sb(),v.Sb()}}let K=(()=>{class e{constructor(e,t,n,i,s,o,r){this.router=e,this.fb=t,this.csrv=n,this.cgrid=i,this.cuser=s,this.cgsend=o,this.cticket=r,this.KEY_GRID_TYPE="send_report",this.agOption=this.createAgOption(),this.agColumns=[],this.agColumnFix={},this.agData=[],this.agColumnApi=void 0,this.agApi=void 0,this.isRunImport=!1,this.isSendReport=!1,this.isLoadSearch=!1,this.isInitPage=!1,this.dataCache=[],this.totalRow=0,this.execRunImport=void 0,this.execRunSend=void 0,this.msgObj=this.msgSendDefault()}ngOnInit(){this.isInitPage=!0,this.searchForm=this.fb.group({fromToDate:[[new Date,new Date]]}),this.userDetail=this.cuser.read(),this.cgrid.getColumnAgFromCache(c.b).subscribe(e=>{this.agColumnFix=e.column_fix,this.agColumns=this.agColumnFix.def,this.isInitPage=!1},e=>{this.isInitPage=!1,console.log(e)}),this.onSeachTicket()}test(){let e=new D,t=e.createElement("Relationships");t.setAttribute("xmlns","http://schemas.openxmlformats.org/package/2006/relationships"),[{Id:"rId1",Type:"1",Target:"path/1.xml"},{Id:"rId2",Type:"2",Target:"path/2.xml"},{Id:"rId3",Type:"3",Target:"path/3.xml"},{Id:"rId4",Type:"4",Target:"path/4.xml"},{Id:"rId5",Type:"5",Target:"path/5.xml"},{Id:"rId6",Type:"6",Target:"path/6.xml"}].map(t=>((e,t)=>{let n=t.createElement("Relationship");return Object.keys(e).forEach(t=>n.setAttribute(t,e[t])),n})(t,e)).forEach(e=>t.appendChild(e)),console.log(t.getXmlText())}onTest(){}get totalSelect(){return Object(a.i)(this.agApi)?0:this.agApi.getSelectedRows().length}get disabledAction(){return this.isLoadSearch||this.isRunImport||this.isSendReport||this.isInitPage}get cfig(){return this.csrv.cfig().read()}msgSendDefault(){return{title:"K\u1ebft qu\u1ea3",total:0,ok:0,err:0,action:""}}createAgOption(){return{domLayout:"autoHeight"}}sortGridByIndex(e){Object(a.i)(this.agApi)||this.agApi.setSortModel([{colId:"index_stt",sort:e}])}onAgInit(e){this.agColumnApi=e.columnApi,this.agApi=e.api,this.cgrid.getColumnAgFromCache(c.a).subscribe(e=>{p.a.fixColDef(this.userDetail,this.agApi),p.a.showOnlyColumns(this.agColumnApi,null,e.grid_field.send_report)},e=>{this.isInitPage=!1,console.log(e)})}onSeachTicket(){if(this.searchForm.invalid)return;this.dataCache=[],this.totalRow=0,this.isLoadSearch=!0;const e=this.searchForm.value,t=new i.d("en-US").transform(e.fromToDate[0],"yyyy-MM-dd")+"T00:00:00",n=new i.d("en-US").transform(e.fromToDate[1],"yyyy-MM-dd")+"T23:59:59";let s=`L\u1ea5y d\u1eef li\u1ec7u <br/>- T\u1eeb ng\xe0y: <b>${t}</b> <br/> - \u0110\u1ebfn ng\xe0y: <b>${n}</b>`,o=this.csrv.shared().loading("\u0110ang "+s);this.cticket.findByCreateOn(t,n).subscribe(e=>{this.dataCache=e=null===e?[]:e,this.convertTicket(e),this.isLoadSearch=!1,this.csrv.alert().remove(o.messageId),this.csrv.alert().success(`[${e.length}] L\u1ea5y Ticket xong r\u1ed3i.`),this.sortGridByIndex("asc")},e=>{this.isLoadSearch=!1,this.csrv.alert().remove(o.messageId),a.f.log("X\u1ea3y ra l\u1ed7i l\u1ea5y d\u1eef li\u1ec7u:",e)})}convertTicket(e=this.dataCache){this.agData=[];let t=1;for(let n in e){let i=e[n];for(let e in i.chanels){let n=Object.assign({},i,{index_stt:t++,first_chanel:i.chanels[e]});this.totalRow++,this.agData.push(n)}}}goHome(){this.router.navigateByUrl("/")}importXsl(){this.csrv.modal().create({nzTitle:"N\u1ea1p d\u1eef li\u1ec7u t\u1eeb file excel",nzContent:h.a,nzClassName:"select-file",nzClosable:!1,nzMaskClosable:!1,nzFooter:null,nzComponentParams:{fileMau:this.cfig.report_filemau}}).afterClose.subscribe(e=>{if("import"===e.act){this.isRunImport=!0;let t=this.agApi.getDisplayedRowCount(),n=e.data.items.map((e,n)=>Object.assign(Object.assign({},e),{index_stt:t+n+1,ticket_text:e.ticket_number,chanels:[{value:e.channel_status}],software:{value:e.soft_name},content_help:e.content_support})),i=Object(g.a)(...n).pipe(Object(f.a)(e=>Object(g.a)(e).pipe(Object(T.a)(2e3))));this.execRunImport=i.subscribe(e=>this.agApi.updateRowData({add:[e]}),e=>console.warn(e));let s=Object(m.a)(1e3).subscribe(e=>{!Object(a.i)(this.execRunImport)&&this.execRunImport.closed&&(this.isRunImport=!1,s.unsubscribe())})}})}onStopImport(){Object(a.i)(this.execRunImport)||this.execRunImport.unsubscribe()}exportXsl(){p.a.exportExcel(this.agApi,this.agColumnApi,{fileName:"send_report"})}onSendReport(){this.test();let e=this.agApi.getSelectedNodes();if(0===e.length)return void this.csrv.alert().warning("Vui l\xf2ng ch\u1ecdn d\u1eef li\u1ec7u \u0111\u1ec3 g\u1eedi");let t=this.cuser.read().od_user.email;if(Object(a.l)(t))return void this.csrv.modal().error({nzTitle:"C\u1ea3nh b\xe1o",nzContent:"L\u1ed7i x\xe1c nh\u1eadn email",nzClosable:!1,nzCancelText:"Oki",nzOkText:null});console.log(this.agApi.getDataAsExcel()),this.isSendReport=!0,this.msgObj=this.msgSendDefault();let n=e.map(e=>Object(g.a)(e.rowIndex).pipe(Object(S.a)(t=>this.refreshRow(e,{send_status:!0})),Object(z.a)(n=>this.handlerSendNode(e,t))));this.execRunSend=Object(g.a)(...n).pipe(Object(f.a)(e=>e.pipe(Object(T.a)(2e3)))).subscribe(e=>{this.refreshRow(e.node,Object.assign(Object.assign({},e.data),{send_status:e.status,is_greport:!0})),"error"===e.status?(this.msgObj.err++,this.showErrorAndStop(e.node.data.ticket_id,e.data.error)):this.msgObj.ok++},e=>{this.msgObj.err++,this.refreshRow(e.node,{send_status:"error"}),this.showErrorAndStop(e.node.data.ticket_id,e.error)});let i=Object(m.a)(500).subscribe(e=>{!Object(a.i)(this.execRunSend)&&this.execRunSend.closed&&(this.isSendReport=!1,i.unsubscribe())},Object(O.a)(1))}handlerSendNode(e,t){let n=this.getAgValueText(e),i=e.data.ticket_id;return Object(a.k)(i,0),this.cgsend.sendRow(t,n).pipe(Object(S.a)(e=>this.cticket.updateOne(i,{is_greport:!0}).subscribe()),Object(z.a)(t=>Object(g.a)({status:"success",node:e,data:t})),Object(y.a)(t=>Object(g.a)({status:"error",node:e,data:{error:t}})))}getAgValueText(e){let t=this.agApi.valueService;return this.agColumnApi.getAllDisplayedColumns().map(n=>{let i=t.getValue(n,e);return{[n.getColId()]:i}}).reduce((e,t)=>Object.assign(Object.assign({},e),t),{})}onStopSendReport(){Object(a.i)(this.execRunSend)||(this.execRunSend.unsubscribe(),this.csrv.alert().error("\u0110\xe3 d\u1eebng g\u1eedi !!"))}showErrorAndStop(e,t){this.csrv.alert().error(`[${e}] > ${t.message}`),this.onStopSendReport()}refreshRow(e,t={}){p.a.refreshRow(this.agApi,e,t)}}return e.\u0275fac=function(t){return new(t||e)(v.Nb(s.d),v.Nb(r.e),v.Nb(b.a),v.Nb(u.a),v.Nb(l.a),v.Nb(x),v.Nb(d.a))},e.\u0275cmp=v.Hb({type:e,selectors:[["cy-send-report"]],decls:72,vars:24,consts:[[1,"send-report"],[1,"mt-2","mb-2","d-flex","align-self-center"],[3,"formGroup","ngSubmit"],["formControlName","fromToDate",1,"range-date",3,"nzFormat"],["nz-button","","nzType","dash",1,"ml-1",3,"disabled"],["nz-icon","",3,"nzType","nzSpin",4,"ngIf"],["nz-icon","","nzType","search","theme","outline",4,"ngIf"],["nz-button","","nz-dropdown","","nzTrigger","click",3,"nzDropdownMenu","disabled"],["nz-icon","","nzType","solution",4,"ngIf"],["nzMenuNXDL",""],["nz-menu",""],["nz-menu-item","",3,"click"],["nz-icon","","nzType","upload"],["nz-icon","","nzType","download"],["nz-button","",3,"click",4,"ngIf"],["nz-button","",3,"disabled","click"],["nz-icon","","nzType","cloud","theme","outline",4,"ngIf"],["nz-button","","nz-dropdown","","nzTrigger","click",3,"nzDropdownMenu","nzDisabled"],["nz-icon","","nzType","desktop"],["nzMenuOther",""],["nz-menu-item",""],["target","_blank"],["nz-icon","","nzType","file-excel"],["nz-icon","","nzType","google"],["nz-icon","","nzType","database"],["nz-icon","","nzType","contacts"],[1,"d-flex","tool-send"],[1,"d-flex"],[1,"text-danger","font-weight-bold","ml-1"],[1,"ml-2"],[4,"ngIf"],[1,"mb-4"],[3,"options","columns","rows","gridReady"],["nz-icon","",3,"nzType","nzSpin"],["nz-icon","","nzType","search","theme","outline"],["nz-icon","","nzType","solution"],["nz-button","",3,"click"],["nz-icon","",3,"nzType"],["nz-icon","","nzType","cloud","theme","outline"],["nzType","vertical",1,"align-self-center"],[1,"send-log","d-flex","align-items-center"],[1,"oki"],[1,"err"],[1,"total"],[1,"run"],[1,"btnStopSend",3,"click"]],template:function(e,t){if(1&e&&(v.Tb(0,"div",0),v.Tb(1,"div",1),v.Tb(2,"div"),v.Tb(3,"form",2),v.ac("ngSubmit",(function(){return t.onSeachTicket()})),v.Ob(4,"nz-range-picker",3),v.Tb(5,"button",4),v.Bc(6,F,1,2,"i",5),v.Bc(7,X,1,0,"i",6),v.Dc(8,"L\u1ea5y d\u1eef li\u1ec7u "),v.Sb(),v.Sb(),v.Sb(),v.Tb(9,"div"),v.Tb(10,"button",7),v.Bc(11,$,1,0,"i",8),v.Bc(12,P,1,2,"i",5),v.Tb(13,"span"),v.Dc(14,"N\u1ea1p / Xu\u1ea5t DL"),v.Sb(),v.Sb(),v.Tb(15,"nz-dropdown-menu",null,9),v.Tb(17,"ul",10),v.Tb(18,"li",11),v.ac("click",(function(){return t.importXsl()})),v.Tb(19,"a"),v.Ob(20,"i",12),v.Dc(21,"N\u1ea1p d\u1eef li\u1ec7u"),v.Sb(),v.Sb(),v.Tb(22,"li",11),v.ac("click",(function(){return t.exportXsl()})),v.Tb(23,"a"),v.Ob(24,"i",13),v.Dc(25,"Xu\u1ea5t d\u1eef li\u1ec7u"),v.Sb(),v.Sb(),v.Sb(),v.Sb(),v.Sb(),v.Bc(26,G,4,1,"button",14),v.Tb(27,"button",15),v.ac("click",(function(){return t.onSendReport()})),v.Bc(28,J,1,0,"i",16),v.Bc(29,U,1,2,"i",5),v.Tb(30,"span"),v.Dc(31,"G\u1eedi BC"),v.Sb(),v.Sb(),v.Tb(32,"div"),v.Tb(33,"button",17),v.Ob(34,"i",18),v.Tb(35,"span"),v.Dc(36,"Th\xeam"),v.Sb(),v.Sb(),v.Tb(37,"nz-dropdown-menu",null,19),v.Tb(39,"ul",10),v.Tb(40,"li",20),v.Tb(41,"a",21),v.Ob(42,"i",22),v.Dc(43,"File m\u1eabu "),v.Sb(),v.Sb(),v.Tb(44,"li",20),v.Tb(45,"a",21),v.Ob(46,"i",23),v.Dc(47,"File b\xe1o c\xe1o "),v.Sb(),v.Sb(),v.Tb(48,"li",11),v.ac("click",(function(){return t.onTest()})),v.Ob(49,"i",24),v.Tb(50,"span"),v.Dc(51,"Test"),v.Sb(),v.Sb(),v.Tb(52,"li",11),v.ac("click",(function(){return t.goHome()})),v.Ob(53,"i",25),v.Tb(54,"span"),v.Dc(55,"T\u1ea1o ticket"),v.Sb(),v.Sb(),v.Sb(),v.Sb(),v.Sb(),v.Sb(),v.Tb(56,"div",26),v.Tb(57,"div",27),v.Tb(58,"div"),v.Tb(59,"label"),v.Dc(60,"T\u1ed5ng s\u1ed1: "),v.Sb(),v.Tb(61,"i",28),v.Dc(62),v.Sb(),v.Sb(),v.Tb(63,"div",29),v.Tb(64,"label"),v.Dc(65,"K\xeanh: "),v.Sb(),v.Tb(66,"i",28),v.Dc(67),v.Sb(),v.Sb(),v.Sb(),v.Bc(68,q,20,4,"ng-container",30),v.Bc(69,H,5,0,"div",30),v.Sb(),v.Tb(70,"div",31),v.Tb(71,"cy-ag-table",32),v.ac("gridReady",(function(e){return t.onAgInit(e)})),v.Sb(),v.Sb(),v.Sb()),2&e){const e=v.rc(16),n=v.rc(38);v.zb(3),v.jc("formGroup",t.searchForm),v.zb(1),v.jc("nzFormat","yyyy-MM-dd"),v.zb(1),v.jc("disabled",t.disabledAction),v.zb(1),v.jc("ngIf",t.isLoadSearch),v.zb(1),v.jc("ngIf",!t.isLoadSearch),v.zb(3),v.jc("nzDropdownMenu",e)("disabled",t.disabledAction),v.zb(1),v.jc("ngIf",!t.isRunImport),v.zb(1),v.jc("ngIf",t.isRunImport),v.zb(14),v.jc("ngIf",t.isRunImport),v.zb(1),v.jc("disabled",t.disabledAction),v.zb(1),v.jc("ngIf",!t.isSendReport),v.zb(1),v.jc("ngIf",t.isSendReport),v.zb(4),v.jc("nzDropdownMenu",n)("nzDisabled",t.disabledAction),v.zb(8),v.Ab("href",null==t.cfig?null:t.cfig.report_filemau,v.uc),v.zb(4),v.Ab("href",null==t.cfig?null:t.cfig.report_excel,v.uc),v.zb(17),v.Ec(t.dataCache.length),v.zb(5),v.Ec(t.totalRow),v.zb(1),v.jc("ngIf",t.totalSelect>0||!!t.msgObj),v.zb(1),v.jc("ngIf",t.isSendReport),v.zb(2),v.jc("options",t.agOption)("columns",t.agColumns)("rows",t.agData)}},directives:[r.t,r.m,r.h,w.a,w.c,r.l,r.g,k.a,A.a,C.a,i.n,_.c,_.a,_.d,B.c,B.d,M.a,E.a,N.a,L.c],styles:[".send-report .range-date{width:240px}.send-report .tool-send .send-log{width:unset}.send-report .tool-send .send-log label{margin-right:5px}.send-report .tool-send .send-log label i{margin-left:5px}.send-report .tool-send .send-log label .err{color:var(--red)}.send-report .tool-send .send-log label .oki{color:var(--success)}.send-report .tool-send .send-log label .total{color:var(--indigo)}.send-report .tool-send .send-log label .run{color:var(--info)}.send-report .tool-send .send-log label .act{color:var(--primary)}.send-report .ag-grid2 .fal{font-size:1rem;font-weight:inherit}.send-report .ag-grid2 .fal.fa-exclamation-circle{color:var(--red)}.send-report .ag-grid2 .fal.fa-times{color:var(--danger)}.send-report .ag-grid2 .fal .fa-check,.send-report .ag-grid2 .fal.fa-comment{color:var(--info)}"],encapsulation:2}),e})();var Y=n("d+64"),Z=n("qPk4"),Q=n("5VY1");const W=[{path:"",component:K}];let ee=(()=>{class e{}return e.\u0275mod=v.Lb({type:e}),e.\u0275inj=v.Kb({factory:function(t){return new(t||e)},imports:[[i.b,o.d,r.i,r.q,s.g.forChild(W),Y.a,k.c,M.b,_.b,w.b,Q.a,Z.b,L.e,N.b]]}),e})()}}]);